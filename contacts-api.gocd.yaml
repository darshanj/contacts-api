environments:
  contacts-api-docker:
    pipelines:
      - api-package
      - api-compile

pipelines:
  api-compile:
    group: contacts-app
    materials:
      mygit:  # this is the name of material
        # says about type of material and url at once
        git: https://github.com/darshanj/contacts-api.git
    stages:
      - build: # name of stage
          jobs:
            build: # name of the job
              tasks:
                - exec: # indicates type of task
                   command: bash
                   arguments:
                     - "-c"
                     - "echo yarn install and npm test"
              resources:
                - yarn
  api-package:
    group: contacts-app
    materials:
      compilation:
        pipeline: api-compile
        stage: build
      mygit:
        git: https://github.com/darshanj/contacts-api.git
    stages:
      - build:
          jobs:
            build:
              tasks:
                - exec:
                   command: bash
                   arguments:
                     - "-c"
                     - "docker build -t contacts-api:${GO_PIPELINE_LABEL} ."
                - exec:
                   command: bash
                   arguments:
                     - "-c"
                     - "echo contacts-api:${GO_PIPELINE_LABEL} > contacts-api-version.txt"
              artifacts:
                - build:
                    source: contacts-api-version.txt
              resources:
                - docker
      - publish:
          jobs:
            publish:
              tasks:
                - fetch:
                   stage: build
                   job: build
                   is_file: yes
                   source: contacts-api-version.txt
                - exec:
                   command: bash
                   arguments:
                     - "-c"
                     - "docker login --username ${DOCKERHUB_USER} --password ${DOCKERHUB_PASSWORD}"
                - exec:
                   command: bash
                   arguments:
                     - "-c"
                     - "docker tag `cat contacts-api-version.txt` ${DOCKERHUB_USER}/`cat contacts-api-version.txt`"
                - exec:
                   command: bash
                   arguments:
                     - "-c"
                     - "docker push ${DOCKERHUB_USER}/`cat contacts-api-version.txt`"
                - exec:
                   command: bash
                   arguments:
                     - "-c"
                     - "echo ${DOCKERHUB_USER}/`cat contacts-api-version.txt` > contacts-api-image-version.txt"
              artifacts:
                - build:
                    source: contacts-api-image-version.txt
              resources:
                - docker
